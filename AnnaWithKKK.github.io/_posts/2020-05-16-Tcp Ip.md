---
layout: post
title:  "Master TCP/IP 读书笔记"
date:   2020-05-09 10:30:00
categories: coding4fun
tags: [Tcp/IP, blog]
---

Master Tcp Ip 的部分读书笔记<!-- more -->

## . 网络基础知识

- 分组交换协议： 将大数据分割为一个个包（Packet）的较小单位进行传输的方法。


- 协议分层（OSI参考模型）: 参考模型定了每层的“作用”，定义每层“作用”的是“协议”，“协议”是约定，其具体内容为“规范”。我们日常使用的就是遵循各个协议具体“规范”的产品和通信手段。

```
物理层 --- 数据链路层 --- 网络层 --- 传输层 --- 会话层 --- 表示层 --- 应用层
1              2            3         4          5           6          7
```

- 应用层：针对特定应用的协议，如电子邮件/远程登录/文件传输协议等。
- 表示层：设备固有数据格式和网络标准数据格式的转换，接收不同形式的信息，如文字流/图像/声音等。
- 会话层：通信管理，负新建和断开通信连接（数据流动的逻辑通路），管理传输层以下的分层。
- 传输层：管理两个节点之间的数据传输，负责可靠传输。
- 网络层：主要负责寻址和路由选择。
- 数据链路层：负责物理层面上互联、节点之间的通信传输，将0、1序列划分为有意义的数据帧传送给对端（数据帧的生成与接收）
- 物理层：负责界定连接器和网线的规格，负责0、1比特流与电压的高低、光的闪灭之间互换。

- 传输的分类
  - 面向有连接型与面向无连接型
  - 电路交换与分组交换
  - 根据接收端数量分类

- 地址：唯一性和层次性（其中MAC地址无层次性）

- 传输速率与吞吐量，数据流动的物理速率和主机之间实际的传输速率，吞吐量不仅衡量带宽，同时也衡量主机的CPU处理能力、网络拥堵程度、报文中数据字段的占有份额（不含报文首部，只计算数据字段本身）等信息

- 网络的构成要素
  - 网卡：使计算机联网的设备 Network Interface
  - 中继器（Repeater)：在1物理层上延长网络的设备，多个端口的中继器又叫集线器，不能连接两个不同速率的网络（需要网桥or路由器）
  - 网桥/2层交换机：在数据链路层连接两个网络的设备，可以识别链路层的数据帧并存储重新生成转发（由此可以连接不同速率网络），还能通过地址自学机制和过滤功能控制网络流量。
  - 路由器/3层交换机：在网络层连接两个网络、并对分组报文进行转发的设备。网桥根据物理地址（MAC地址）进行处理，路由器根据IP地址进行处理。路由器可以连接不同数据链路（如以太网和FDDI），还能分担网络负荷（由于路由器会分割数据链路，因此数据链路层的广播消息将无法继续传播），甚至有的路由器具备一定的网络安全功能
  - 4-7层交换机：负责处理OSI模型中传输层到应用层的数据，以TCP/IP等协议的传输层及其上面的应用层为基础，分析收发数据，对其进行特定处理。如负载均衡器（分配多台服务器分担同一前端访问需求，当然也可以通过循环服用DNS技术实现负载均衡(1 domain name -> N ip)），以及带宽控制、广域网加速器、特殊应用加速及防火墙等。
  - 网关：负责从传输层到应用层的数据进行转换和转发的设备，和4-7层交换机一样都是处理传输层以上数据，但网关不仅转发数据还负责对数据进行转换，通常使用一个表示层或应用层网关，在两个不能直接通信的协议之间进行翻译，如互联网邮件与手机邮件之间的转换服务，如控制网络流量以及出于安全考虑使用的代理服务器也是网关一种，称为应用网关。防火墙也是一款通过网关通信针对不同应用提高安全性的产品。



## 2  TCP / IP 基础知识

### 2.1 TCP / IP 协议分层模型

- OSI 参考模型与 TCP/IP 的关系

|                      |                                                              |                        |
| :------------------: | :----------------------------------------------------------- | :--------------------: |
| 应用层/表示层/会话层 | 应用层 TELNET, SSH, HTTP, SMTP, POP, SSL/TLS, FTP, MIME, HTML, SNMP, MIB, SIP, RTP... |        应用程序        |
|        传输层        | 传输层 TCP, UDP, UDP-LITE, SCTP, DCCP                        |           os           |
|        网络层        | 互联网层 ARP, IPv4, IPV6, ICMP, IPsec                        |           os           |
|  数据链路层/物理层   | 以太网、无线LAN，PPP...                                      | 设备驱动程序与网络接口 |
|        物理层        | （硬件）                                                     | 设备驱动程序与网络接口 |

```
OSI 参考模型注重“通信协议必要的功能是什么”, TCP/IP 更强调“在计算机上实现协议应该开发哪种程序”
```

- 互联网层

  使用 IP 协议，相当与 OSI 模型中的第3层 网络层。IP 协议基于 IP 地址转发分包数据。

  TCP / IP 分层中的互联网层与传输层的功能通常由操作系统提供。

  - IP 

    IP 是跨越网络传送数据包，使整个互联网都能收到数据的协议，使用 IP 地址作为主机的标识。

    隐含数据链路层功能，通过 IP， 相互通信的主机之间无论经过怎么样的底层数据链路都能实现通信。

    是分组交换的一种协议，不具有重发机制，属于非可靠性传输协议。

  - ICMP

    IP 数据包在发送途中一旦发生异常导致无法到达对端目标地址时，需要给发送端发送一个异常通知。ICMP 即为这个制定的，有时也被用来诊断网络健康状态。

  - ARP

    从分组数据包的 IP 地址中解析出物理地址（MAC 地址）的一种协议。

    

- 传输层

  主要功能是让应用程序之间实现通信。计算机内部，通常同一时间运行多个程序，须分清哪些程序与哪些程序进行通信，识别这些应用程序的是端口号。

  - TCP

    一种面向有连接的传输层协议，可以保证两端通信主机之间的通信可达。能正确处理在传输过程中丢包、传输顺序错乱等异常情况。此外，还能有效利用带宽，缓解网络拥堵。

    然而，为了建立和断开连接，有时需要至少7次的发包收包，导致网络流量浪费。此外，为了提高网络利用率，TCP 协议还定义各种复杂的规范，因此不利于视频会议（音频、视频的数据量既定）等场合。

  - UDP

    有别于 TCP，是一种面向无连接的传输层协议。UDP 不会关注对端是否真的收到传送的数据，如果需要检查对端是否收到分组数据包，或者对端是否连接到网路，则需要在应用程序中实现。

    UDP 常用于分组数据较少或多播、广播通信以及视频通信等多媒体领域。

    

- 应用层（会话层以上的分层）

  TCP / IP 分层中，将 OSI 参考模型中的会话层、表示层、应用层的功能都集中到了应用程序中实现。

  TCP / IP 应用的架构绝大多数属于客户端 / 服务端模型。提供服务的程序叫服务端，接受服务的程序叫客户端。在这种通信模式中，提供服务的程序会预先被部署到主机上，等待接收任何时刻客户可能发送的请求。

  - WWW

    中文叫做万维网，是一种互联网上数据读取的规范，通常可简化称作浏览器。

    浏览器与服务器之间通信用的协议是 HTTP (HyperText Transfer Protocol)，所传输数据的主要格式是 HTML (HyperText Markup Language)。WWW 中的 HTTP 属于 OSI 应用层的协议，而 HTML 属于表示层的协议。

  - E-Mail

    发送电子邮件用到的协议叫做 SMTP (Simple Mail Transfer Protocol)。

    最初，只能发送文本格式的电子邮件，薪资经 MIME 协议扩展后，可以发送声音、图像等各式各样的信息，还可以修改邮件文字的大小、颜色。MIME 属于 OSI 第六层——表示层。

  - 文件传输（FTP）

    文件传输使用的协议 FTP  (File Transfer Protocol)，传输过程中可以选择使用二进制还是文本方式。

    FTP 进行文件传输时会建立两个 TCP 连接，分别是发出传输请求时所要用到的控制连接和实际传输数据时用到的数据连接。

  - 远程登录（TELNET 与 SSH）

    远程登录是指登录到远程的计算机上，使那台计算机上的程序得以运行的一种功能。TCP / IP 网络中远程登录常用到 TELNET 和 SSH 两种协议；此外还有 BSD UNIX 中的rlogin 的 r 命令协议以及 X Window System 中的 X 协议。

  - 网络管理（SNMP）

    在 TCP / IP 中进行网络管理时，采用 SNMP （Simple Network Management Protocol）协议。使用 SNMP 管理的主机、网桥、路由器等称作 SNMP 代理（Agent），而进行管理的那一段叫做管理器（Manager）。SNMP 正是这个 Manager 与 Agent 所要用到的协议。

    在 SNMP 代理端，保存着网络接口的信息、通信数据量、异常数据量以及设备温度等信息。这些信息可以通过 MIB（Management Information Base）访问。因此，在 TCP / IP 的网络管理中，SNMP 属于应用协议，MIB 属于表示层协议。

### 2.2 TCP / IP 分层模型与通信示例

介绍使用 TCP / IP 时，从应用层到物理媒介为止数据处理的流程。

- 数据包首部

  以太网包首部 | （IP 包首部）| （TCP 包首部）| （数据）

  ​                       | IP 包首部       | TCP 包首部       | 数据

  ​                                               | TCP 包首部       | 数据

  每个分层中，都会对所发送的数据附加一个首部，在这个首部中包含了该层必要的信息，如发送的目标地址以及协议相关信息。

  - 包、帧、数据报、段、消息

    包可以说是全能术语。帧用来表示数据链路层中包的单位；数据报是 IP 和 UDP 等网络层以上的分层中包的单位；段则表示 TCP 数据流中的信息。最后，消息指应用协议中数据的单位。

- 发送数据包

  假设甲向乙发送电子邮件，从 TCP / IP 通信上看，是从一台计算机 A 向另一台计算机 B 发送电子邮件。

  1. 应用程序的处理

     首先进行编码（如 utf-8），相当于 OSI 表示层功能。

     编码后，何时建立通信连接何时发送的管理功能，宽泛地看属于 OSI 会话层。

     发送邮件的一刻建立 TCP 连接，并利用这个 TCP 连接发送数据。过程是首先将应用的数据发送给下一层的 TCP，再做实际的转发处理。

  2. TCP 模块的处理

     TCP 根据应用的指示（关于连接的指示相当于 OSI 参考模型的会话层），负责建立连接、发送数据以及断开连接。TCP 提供将应用层发来的数据顺利发送至对端的可靠传输。

     为实现这一功能，需要在应用层数据的前端附加一个 TCP 首部。TCP 首部中包括源端口号和目标端口号（用以识别发送主机和接收主机上的应用）、序号（用以表示该包中数据是发送端整个数据第几字节的序列号）以及校验和（用以判断数据是否被损坏）。随后将附加了 TCP 首部的包再发送给 IP。

  3. IP 模块的处理

     IP 将 TCP 传过来的 TCP 首部和 TCP 数据合起来当作自己的数据，并在 TCP 首部的前端再加上自己的 IP 首部。IP 首部中包含接收端 IP 地址以及发送端 IP 地址。紧随 IP 首部的还有用来判断其后数据是 TCP 还是 UDP 的信息。

     IP 包生成后，参考路由控制表决定接受此 IP 包的路由或主机。随后，IP 包将被发送给连接这些路由器或主机网络接口的驱动程序，以实现真正发送数据。

  4. 网络接口（以太网驱动）的处理

     从 IP 传过来的 IP 包，对于以太网驱动来说就是数据。给这些数据附加上以太网首部并进行发送处理。以太网首部包含接收端 MAC 地址、发送端 MAC 地址以及标志以太网类型的以太网数据的协议。根据上述信息产生的以太网数据包将通过物理层传输给接收端。发送处理中的 FCS （Frame Check Sequence）由硬件计算，添加到包的最后。设置 FCS 的目的在于判断数据包是否由于噪声而被破坏。

     

- 经过数据链路的包

  数据链路层			接收端 MAC 地址  +  发送端 MAC 地址  +  以太网类型

  网络层				   发送端 IP 地址       +  接收端 IP 地址      +  协议类型

  传输层   				 源端口号               +  目标端口号

  会话/表示/应用层    数据链路

  数据链路层             循环冗余校验

  每个分层的包首部还包含一个识别位，用来标识上一层协议的种类信息。如以太网的包首部中的以太网类型，IP 中的协议类型以及 TCP / UDP 中两个端口的端口号等都起着识别协议类型的作用。在应用的首部信息中，有时也会包含一个识别其数据类型的标签。

  

- 数据包接收处理

  包的接收流程是发送流程的逆序过程。

  5. 网络接口（以太网驱动）的处理

     主机收到以太网包后，首先从以太网的包首部找到 MAC 地址判断是否为发给自己的包。如果不是则丢弃数据（很多 NIC 产品可以设置为即使不是发给自己的包也不丢弃，用来监控数据流量）

     如果是发给自己的，查找首部中类型域从而确定以太网协议所传送过来的数据类型。如果数据类型 IP 包，则传给处理 IP 的子程序，如别的如 ARP 的协议，则数据传给 ARP 处理，如无法识别的协议类型，则丢弃数据。

  6. IP 模块的处理

     IP 模块接收到 IP 包首部及后面的数据部分后，也做类似处理。如果判断得出首部中的 IP 地址与自己 IP 地址匹配，则接收数据并从中查找上一层的协议。如果上一层是 TCP 就将 IP 首部之后的部分传给 TCP 处理；如果是 UDP 则将 IP 包首部后部分传给 UDP 处理。对于有路由器的情况下，接收端地址往往不是自己的地址，此时，需要借助路由控制表，在查询应该送达的主机或路由器之后再转发数据。

  7. TCP 模块的处理

     在 TCP 模块中，首先计算下校验和，判断数据是否被破坏。然后检查是否在按照序号接收数据。最后检查端口号，确定具体的应用程序。

     数据接收完毕后，接收端发送一个“确认回执”给发送端。如果这个回执信息未能达到发送端，那么发送端会认为接收端没有接收到数据而一直反复发送。

     数据被完整地接收后，会传给由端口号识别的应用程序。

  8. 应用程序的处理

  

  

  ## 3  数据链路

  

  

    

